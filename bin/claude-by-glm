#!/bin/bash
#
# claude-by-glm - Claude Code launcher for Z.ai GLM models
#
# This script sets up the environment for using Z.ai GLM models
# with Claude Code, then launches the claude command.
#
# Platform support:
# - macOS: Keychain (security command)
# - Linux: libsecret (secret-tool)
# - Windows: Environment variable (ZAI_API_KEY)
#
# Environment variables:
#   GLM_MODEL_REPO - Optional: Custom model repository URL
#   GLM_SKIP_PATH  - If set, skip PATH modification
#
# Usage:
#   ~/.claude-glm-mcp/bin/claude-by-glm [claude arguments...]
#

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Source shared utilities
source "$PROJECT_DIR/scripts/common-utils.sh"

# Source credential abstraction (loads security.conf)
source "$PROJECT_DIR/credentials/common.sh"

# Initialize credential backend
credential_init

# Fetch API key from credential storage
fetch_api_key() {
    local api_key
    api_key="$(credential_fetch "$KEYCHAIN_SERVICE" "$KEYCHAIN_ACCOUNT" 2>/dev/null)" || return 1

    # Basic validation
    if [[ -z "$api_key" ]]; then
        return 1
    fi

    echo "$api_key"
}

# Setup PATH for this session
setup_path() {
    if [[ "${GLM_SKIP_PATH:-}" == "1" ]]; then
        return 0
    fi

    # Add ~/.claude-glm-mcp/bin to PATH if not already there
    local glm_bin="$HOME/.claude-glm-mcp/bin"
    if [[ -d "$glm_bin" ]]; then
        case ":$PATH:" in
            *:"$glm_bin":*) ;;
            *)
                export PATH="$glm_bin:$PATH"
                print_info "Added to PATH: $glm_bin"
                ;;
        esac
    fi
}

# Load MCP configuration from file (safe parsing, not code execution)
load_mcp_config() {
    local config_file="$HOME/.claude-glm-mcp/config/mcp.conf"

    # Default: MCP enabled (more features)
    export GLM_USE_MCP="${GLM_USE_MCP:-1}"

    # Load config file if exists (parse as data, not code)
    if [[ -f "$config_file" ]]; then
        # Extract GLM_USE_MCP value safely (grep + sed, no code execution)
        local mcp_value
        mcp_value=$(grep -E '^GLM_USE_MCP=' "$config_file" 2>/dev/null | tail -1 | sed 's/^GLM_USE_MCP=//' | tr -d '"'"'" | tr -d ' ')

        # Validate: only accept 0 or 1
        if [[ "$mcp_value" == "0" ]] || [[ "$mcp_value" == "1" ]]; then
            export GLM_USE_MCP="$mcp_value"
        elif [[ -n "$mcp_value" ]]; then
            print_warning "Invalid GLM_USE_MCP value in $config_file: '$mcp_value' (expected 0 or 1, using default)"
        fi
    fi
}

# Show GLM MCP Wrapper version
show_glm_version() {
    local version_file="$PROJECT_DIR/VERSION"
    local version="unknown"
    if [[ -f "$version_file" ]]; then
        version="$(cat "$version_file" 2>/dev/null)"
    fi
    echo "claude-by-glm (GLM MCP Wrapper) version $version"
    exit 0
}

# Main execution
main() {
    # Handle --glm-version flag
    if [[ "${1:-}" == "--glm-version" ]]; then
        show_glm_version
    fi

    # Windows special handling
    if [[ "$CREDENTIAL_PLATFORM" == "windows" ]]; then
        if [[ -z "${ZAI_API_KEY:-}" ]]; then
            print_error "ZAI_API_KEY environment variable not set"
            print_info "Set it with: set ZAI_API_KEY=your_api_key"
            exit 1
        fi
        local api_key="$ZAI_API_KEY"
    else
        # Fetch API key from credential storage
        local api_key
        api_key="$(fetch_api_key)"
        local fetch_status=$?

        if [[ $fetch_status -ne 0 ]] || [[ -z "$api_key" ]]; then
            cat << EOF
ERROR: Failed to retrieve Z.ai API key from $(get_credential_storage_name).

Required: service="$KEYCHAIN_SERVICE", account="$KEYCHAIN_ACCOUNT"

Please register your API key first:
  ~/.claude-glm-mcp/bin/install-key.sh

Or get one from: https://z.ai/subscribe?ic=EBGYZCJRYJ
EOF
            exit 1
        fi
    fi

    # Setup PATH
    setup_path

    # Export environment variables for Z.ai GLM models
    export ANTHROPIC_AUTH_TOKEN="$api_key"
    export ANTHROPIC_BASE_URL="https://api.z.ai/api/anthropic"
    export ANTHROPIC_DEFAULT_HAIKU_MODEL="glm-4.5-air"
    export ANTHROPIC_DEFAULT_SONNET_MODEL="glm-4.6"
    export ANTHROPIC_DEFAULT_OPUS_MODEL="glm-4.7"

    # Optional: Custom model repository
    if [[ -n "${GLM_MODEL_REPO:-}" ]]; then
        export ANTHROPIC_MODEL_REPO="$GLM_MODEL_REPO"
        print_info "Using custom model repository: $GLM_MODEL_REPO"
    fi

    # Create session-specific settings for isolation
    # This prevents GLM sessions from affecting default Claude Code sessions
    local glm_sessions_dir="$HOME/.claude/glm-sessions"
    mkdir -p "$glm_sessions_dir"

    # Generate unique session ID based on timestamp and PID
    local session_id
    session_id="glm-$(date +%s)-$$"
    local session_settings="$glm_sessions_dir/$session_id.json"

    # Copy base GLM settings if available, otherwise use default settings
    local base_settings="$HOME/.claude/settings.glm.json"
    if [[ -f "$base_settings" ]]; then
        cp "$base_settings" "$session_settings"
    else
        # Create minimal session settings if base doesn't exist
        cat > "$session_settings" << 'EOF'
{
  "plugins": []
}
EOF
    fi

    # Export CLAUDE_SETTINGS to use session-specific config
    export CLAUDE_SETTINGS="$session_settings"

    # Store session info for cleanup (optional)
    echo "$session_id" > "$glm_sessions_dir/.last-session"

    print_info "Using isolated session settings: $session_settings"

    # Load MCP configuration
    load_mcp_config

    # Activate GLM mode for MCP wrapper (only if MCP is enabled)
    if [[ "$GLM_USE_MCP" == "1" ]]; then
        export GLM_MODE=1
    else
        print_info "MCP disabled (GLM_USE_MCP=0) - running without MCP tools"
    fi

    # Launch claude with all arguments
    # Force opus model to override UI state caching
    exec claude --model opus "$@"
}

main "$@"
