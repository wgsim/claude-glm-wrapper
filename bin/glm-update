#!/bin/bash
#
# glm-update - Update GLM MCP Wrapper installation
#
# This script updates an existing installation by copying only changed files
# from the project directory to the installation directory.
#
# Usage:
#   ~/.claude-glm-mcp/bin/glm-update [options]
#
# Options:
#   --from DIR   Source directory (default: auto-detect)
#   --to DIR     Installation directory (default: ~/.claude-glm-mcp)
#   --force      Force update even if versions match
#   --dry-run    Show what would be updated without actually updating
#

set -euo pipefail

# Detect script directory for sourcing utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source shared utilities
source "$SCRIPT_DIR/scripts/common-utils.sh"

# Default options
SOURCE_DIR=""
INSTALL_DIR="${HOME}/.claude-glm-mcp"
FORCE=0
DRY_RUN=0

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --from)
            SOURCE_DIR="$2"
            shift 2
            ;;
        --to)
            INSTALL_DIR="$2"
            shift 2
            ;;
        --force)
            FORCE=1
            shift
            ;;
        --dry-run)
            DRY_RUN=1
            shift
            ;;
        -h|--help)
            cat << 'EOF'
glm-update - Update GLM MCP Wrapper installation

USAGE:
    glm-update [options]

OPTIONS:
    --from DIR   Source directory (default: auto-detect from script location)
    --to DIR     Installation directory (default: ~/.claude-glm-mcp)
    --force      Force update even if versions match
    --dry-run    Show what would be updated without actually updating
    -h, --help   Show this help message

DESCRIPTION:
    This script updates an existing GLM MCP Wrapper installation by
    copying only changed files from the project directory. It preserves
    your configuration and credentials.

EXAMPLES:
    # Update from project directory
    ~/AI_development/claude-by-glm-safety_setting/scripts/install.sh

    # Update with custom paths
    glm-update --from /path/to/project --to /custom/install

    # Preview what would be updated
    glm-update --dry-run
EOF
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Auto-detect source directory if not specified
if [[ -z "$SOURCE_DIR" ]]; then
    # Try to find project directory from script location
    SCRIPT_SOURCE="${BASH_SOURCE[0]}"
    if [[ -L "$SCRIPT_SOURCE" ]]; then
        SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    fi

    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

    # Check if this looks like the project directory
    if [[ -f "$PROJECT_DIR/credentials/common.sh" ]] && [[ -f "$PROJECT_DIR/VERSION" ]]; then
        SOURCE_DIR="$PROJECT_DIR"
    else
        print_error "Could not auto-detect source directory"
        print_info "Please specify with --from DIR"
        exit 1
    fi
fi

# Validate source directory
if [[ ! -d "$SOURCE_DIR" ]]; then
    print_error "Source directory not found: $SOURCE_DIR"
    exit 1
fi

# Get versions
source_version=$(cat "$SOURCE_DIR/VERSION" 2>/dev/null || echo "unknown")
installed_version="unknown"
if [[ -f "$INSTALL_DIR/VERSION" ]]; then
    installed_version=$(cat "$INSTALL_DIR/VERSION")
fi

print_info "Source version: $source_version"
print_info "Installed version: $installed_version"
print_info "Installation directory: $INSTALL_DIR"

# Check if update is needed
if [[ "$source_version" == "$installed_version" ]] && [[ $FORCE -eq 0 ]]; then
    print_info "Versions match (use --force to update anyway)"
    print_info "No update needed"
    exit 0
fi

# Files to update (excluding VERSION and configs)
FILES_TO_UPDATE=(
    "bin/glm-mcp-wrapper"
    "bin/install-key.sh"
    "bin/claude-by-glm"
    "bin/glm-cleanup-sessions"
    "bin/glm-update"
    "credentials/common.sh"
    "credentials/macos.sh"
    "credentials/linux.sh"
    "credentials/windows.sh"
    "credentials/security.conf"
    "scripts/install.sh"
    "scripts/uninstall.sh"
    "scripts/common-utils.sh"
)

# Check which files need updating
files_to_copy=()
for file in "${FILES_TO_UPDATE[@]}"; do
    source_file="$SOURCE_DIR/$file"
    target_file="$INSTALL_DIR/$file"

    # Skip if source doesn't exist
    if [[ ! -f "$source_file" ]]; then
        continue
    fi

    # Check if update needed
    if [[ ! -f "$target_file" ]]; then
        # File doesn't exist in installation, need to copy
        files_to_copy+=("$file")
    else
        # File exists, check if different
        if ! cmp -s "$source_file" "$target_file" 2>/dev/null; then
            files_to_copy+=("$file")
        fi
    fi
done

if [[ ${#files_to_copy[@]} -eq 0 ]]; then
    print_info "No files need updating"
    exit 0
fi

# Show what will be updated
print_info "Files to be updated (${#files_to_copy[@]}):"
for file in "${files_to_copy[@]}"; do
    echo "  - $file"
done

# Dry run mode
if [[ $DRY_RUN -eq 1 ]]; then
    print_warning "[DRY RUN] Would update ${#files_to_copy[@]} file(s)"
    print_info "Run again without --dry-run to actually update"
    exit 0
fi

# Confirm update
echo
read -rp "Update installation? (y/N): " -n 1 response
echo
if [[ ! $response =~ ^[Yy]$ ]]; then
    print_info "Cancelled"
    exit 0
fi

# Create backup
backup_dir="$INSTALL_DIR/backups/update-$(date +%Y%m%d_%H%M%S)"
mkdir -p "$backup_dir"
print_info "Creating backup: $backup_dir"

# Backup existing files
for file in "${files_to_copy[@]}"; do
    target_file="$INSTALL_DIR/$file"
    if [[ -f "$target_file" ]]; then
        mkdir -p "$backup_dir/$(dirname "$file")"
        cp "$target_file" "$backup_dir/$file"
    fi
done

# Update files
print_info "Updating files..."
updated=0
for file in "${files_to_copy[@]}"; do
    source_file="$SOURCE_DIR/$file"
    target_file="$INSTALL_DIR/$file"

    # Create target directory if needed
    mkdir -p "$(dirname "$target_file")"

    # Copy file and preserve permissions
    cp "$source_file" "$target_file"

    # Make executable if it's a script
    case "$file" in
        bin/*|scripts/*)
            chmod 500 "$target_file"
            ;;
        credentials/*)
            chmod 600 "$target_file"
            ;;
    esac

    updated=$((updated + 1))
done

# Update VERSION
cp "$SOURCE_DIR/VERSION" "$INSTALL_DIR/VERSION"
chmod 600 "$INSTALL_DIR/VERSION"

# Fix ownership if running with sudo
# When script is run with sudo, copied files get root ownership
# We need to restore ownership to the real user
if [[ -n "${SUDO_USER:-}" ]]; then
    print_info "Fixing file ownership to $SUDO_USER..."
    real_user="$SUDO_USER"
    real_group="$(id -gn "$real_user" 2>/dev/null || echo "$real_user")"

    # Fix ownership of updated files
    for file in "${files_to_copy[@]}"; do
        target_file="$INSTALL_DIR/$file"
        if [[ -f "$target_file" ]]; then
            chown "$real_user:$real_group" "$target_file" 2>/dev/null || true
        fi
    done

    # Fix VERSION ownership
    chown "$real_user:$real_group" "$INSTALL_DIR/VERSION" 2>/dev/null || true
fi

print_success "Updated $updated file(s)"

# Show completion message
echo
print_success "Update complete!"
echo
echo "New version: $source_version"
echo "Backup location: $backup_dir"
echo
echo "You may need to restart any running claude-by-glm sessions."
